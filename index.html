<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Level Data Viewer</title>
</head>
<body>
    <h1>Level Data</h1>
    <div id="levelDataContainer"></div>
    <button id="downloadButton">Download Level Data</button>

    <script>
        let accumulatedData = "";
        let allChunks = [];

        // Function to get URL parameters
        function getURLParameters() {
            const params = {};
            const queryString = window.location.search.substring(1);
            const regex = /([^&=]+)=([^&]*)/g;
            let match;
            while (match = regex.exec(queryString)) {
                params[decodeURIComponent(match[1])] = decodeURIComponent(match[2]);
            }
            return params;
        }

        // Function to display level data
        function displayLevelData(data) {
            const container = document.getElementById('levelDataContainer');
            const uniqueData = [];

            // Filter duplicates and accumulate data
            data.forEach(item => {
                const jsonString = JSON.stringify(item);
                if (!uniqueData.some(existingItem => existingItem.object === item.object && existingItem.x === item.x && existingItem.y === item.y)) {
                    uniqueData.push(item);
                    allChunks.push(jsonString); // Add to chunk array for download
                    accumulatedData += jsonString + '\n'; // Add to accumulated data
                }

                // Display each chunk in the div
                const div = document.createElement('div');
                div.textContent = jsonString;
                container.appendChild(div);
            });
        }

        // Function to trigger the download of a .txt file
        function downloadFile(filename, content) {
            const element = document.createElement('a');
            const file = new Blob([content], { type: 'text/plain' });
            element.href = URL.createObjectURL(file);
            element.download = filename;
            document.body.appendChild(element); // Append to the body
            element.click(); // Trigger the download
            document.body.removeChild(element); // Clean up
        }

        // Get the URL parameters and process the data
        const params = getURLParameters();
        if (params.data) {
            try {
                const data = JSON.parse(decodeURIComponent(params.data));
                displayLevelData(data);
            } catch (e) {
                console.error("Failed to parse data: ", e);
            }
        }

        // Add an event listener to the download button
        document.getElementById('downloadButton').addEventListener('click', function () {
            if (accumulatedData) {
                downloadFile('level_data.txt', accumulatedData);
            } else {
                alert('No data available to download.');
            }
        });
    </script>
</body>
</html>
